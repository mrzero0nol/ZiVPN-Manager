#!/bin/bash

display_banner() {
clear
echo -e "\e[1;34m"
echo "  "
echo "       _____ _ __     __ ____   _   _             "
echo "   __/\__|__  /(_)\ \   / /|  _ \ | \ | |__/\__   "
echo "   \    /  / / | | \ \ / / | |_) ||  \| |\    /   "
echo "   /_  _\ / /_ | |  \ V /  |  __/ | |\  |/_  _\   "
echo "   \/  /____||_|   \_/   |_|    |_| \_|  \/       "
echo "  "
echo -e "\e[1;32m   ZiVPN MANAGER - Installer"
echo -e "\e[1;35m   by: @deviyke, @Kwadeous & @voltsshx"
echo -e "\e[1;33m   - v1.6 for @lstunnels"
echo "   === === === === === === === === === === ==="
echo " "
}

startinstall(){
display_banner
echo ""
echo -e "\e[1;36m _> Starting ZiVPN Installation..."
echo ""
}

install_dockzivpn(){
echo -e "\e[1;36m _> Configuring server..."
echo ""
sleep 3
echo -e "\e[1;36m _> Performing system updates and upgrades..."
sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq && sudo apt-get upgrade -y -qq
for pkg in ufw lolcat figlet screen wget zip unzip openssl iptables iproute2 curl; do
if ! command -v $pkg &> /dev/null; then
echo -e "\e[1;33m _> Installing $pkg..."
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq $pkg
fi
done
sudo ln -s /usr/games/lolcat /bin/lolcat 2>/dev/null
echo ""
echo -e "\e[1;36m _> Please wait, we're working on the server..."
sleep 5
echo ""
echo -e "\e[1;36m _> Initializing..."
sleep 3
rm -rf /etc/zivpn 1> /dev/null 2>&1
rm -rf /usr/local/bin/ziv 1> /dev/null 2>&1
rm -rf /usr/local/bin/zivpn 1> /dev/null 2>&1
mkdir -p /etc/zivpn 1> /dev/null 2>&1
mkdir -p /etc/zivpn/k/ 1> /dev/null 2>&1
wget -O /usr/local/bin/ziv https://github.com/mrzero0nol/ZiVPN-Manager/raw/main/ziv/ziv 1> /dev/null 2>&1
chmod +x /usr/local/bin/ziv 1> /dev/null 2>&1
wget -O /usr/local/bin/zivpn https://github.com/mrzero0nol/ZiVPN-Manager/raw/main/girl/babe/kid 1> /dev/null 2>&1
chmod +x /usr/local/bin/zivpn 1> /dev/null 2>&1
wget -O /bin/udp-gw --no-cache https://github.com/vxu007/vxu/raw/main/bin/udp-gw 1> /dev/null 2>&1
chmod +x /bin/udp-gw 1> /dev/null 2>&1
echo -e "\e[1;36m _> Generating SSL certificate..."
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
-subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=zivpn" \
-keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" > /dev/null 2>&1

# Create default config if not exists
if [ ! -f "/etc/zivpn/config.json" ]; then
cat <<EOL | sudo tee /etc/zivpn/config.json >/dev/null
{
  "server": ":5667",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key"
}
EOL
fi

iptables -t nat -A PREROUTING -i $(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1) -p udp --dport 6000:29999 -j DNAT --to-destination :5667 > /dev/null 2>&1
if [ -f "/etc/systemd/system/zivpn.service" ]; then
sudo rm -f /etc/systemd/system/zivpn.service >/dev/null 2>&1
sudo systemctl daemon-reload >/dev/null 2>&1
sudo systemctl reset-failed >/dev/null 2>&1
fi
cat <<EOL | sudo tee /etc/systemd/system/zivpn.service >/dev/null
[Unit]
Description=ZiVPN Manager Service by @deviyke
After=network.target
[Service]
ExecStartPre=/bin/bash -c 'iptables -t nat -A PREROUTING -i $(ip -4 route ls | grep default | grep -Po "(?<=dev )(\S+)" | head -1) -p udp --dport 6000:29999 -j DNAT --to-destination :5667'
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn server -c /etc/zivpn/config.json
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true
Restart=on-failure
RestartSec=5s
[Install]
WantedBy=multi-user.target
EOL
sudo systemctl daemon-reload >/dev/null 2>&1
sudo systemctl enable zivpn >/dev/null 2>&1
sudo systemctl start zivpn >/dev/null 2>&1
echo " "
echo -e "\e[1;36m _> Services up...\e[0m"
echo "#!/bin/bash" > /usr/local/bin/ziv-uninstall
echo "" >> /usr/local/bin/ziv-uninstall
echo "clear" >> /usr/local/bin/ziv-uninstall
echo "echo ' Please wait...'" >> /usr/local/bin/ziv-uninstall
echo "# Uninstall ZiVPN Function" >> /usr/local/bin/ziv-uninstall
echo "" >> /usr/local/bin/ziv-uninstall
echo "uninstall_zivpn() {" >> /usr/local/bin/ziv-uninstall
echo "    # Check if /usr/local/bin/ziv exists" >> /usr/local/bin/ziv-uninstall
echo "    if [ -f /usr/local/bin/ziv ]; then" >> /usr/local/bin/ziv-uninstall
echo "        # Remove the file" >> /usr/local/bin/ziv-uninstall
echo "        rm -f /usr/local/bin/ziv &> /dev/null" >> /usr/local/bin/ziv-uninstall
echo "        echo 'ZiVPN Manager has been removed.'" >> /usr/local/bin/ziv-uninstall
echo "    else" >> /usr/local/bin/ziv-uninstall
echo "        echo 'ZiVPN Manager not found. Nothing to uninstall.'" >> /usr/local/bin/ziv-uninstall
echo "    fi" >> /usr/local/bin/ziv-uninstall
echo "}" >> /usr/local/bin/ziv-uninstall
echo "" >> /usr/local/bin/ziv-uninstall
echo "uninstall_zivpn" >> /usr/local/bin/ziv-uninstall
chmod +x /usr/local/bin/ziv-uninstall 1> /dev/null 2>&1
echo ""
echo -e "\e[1;36m _> Finalizing..."
sleep 5
echo ""
echo -e "\e[1;33m _> Cleaning up installation files..."
sudo find / -type f \( -name "zivstaller.sh" -o -name "zivstall.sh" -o -name "zivstall" \) -exec rm -f {} \; 2>/dev/null
echo -e " "
echo -e "\e[1;32m _> ZiVPN MANAGER - Installed Successfully!"
echo -e " "
echo -e "\e[1;36m _> Run the command \e[1;32m'ziv'\e[1;36m to access the panel."
echo -e " "
echo -e "\e[1;36m _> Contact us on Telegram (@deviyke) for support."
echo -e " "
server_ip=$(curl -s --retry 5 --retry-connrefused --retry-delay 2 https://api.ipify.org)
echo -e "\e[1;33m _> Server IP Address: $server_ip"
echo -e "\e[0m "
if grep -q "server_ip" ~/.bashrc; then
sed -i '/clear/d' ~/.bashrc
sed -i '/ZiVPN MANAGER - v1.5/d' ~/.bashrc
sed -i '/server_ip=/d' ~/.bashrc
sed -i '/Server IP Address: \$server_ip/d' ~/.bashrc
sed -i '/figlet -kE \*ZiVPN\*/d' ~/.bashrc
sed -i '/Run the command/d' ~/.bashrc
sed -i '/Contact us on Telegram/d' ~/.bashrc
fi
echo -e "clear" >> ~/.bashrc
echo -e "figlet -kE *ZiVPN* | lolcat" >> ~/.bashrc
echo -e "server_ip=\$(curl -s --retry 5 --retry-connrefused --retry-delay 2 https://api.ipify.org)" >> ~/.bashrc
echo -e "echo -e \"\e[1;34m\"\n" >> ~/.bashrc
echo -e "echo \"\e[1;32m   ZiVPN MANAGER - v1.5\"\n" >> ~/.bashrc
echo -e "echo \"\e[1;36m   Server IP Address: \$server_ip\"\n" >> ~/.bashrc
echo -e "echo \"\e[1;32m   Run the command 'ziv' to access the panel.\"\n" >> ~/.bashrc
echo -e "echo \"\e[1;33m   Contact us on Telegram (@deviyke) for support.\"\n" >> ~/.bashrc
echo -e 'echo -e "\e[1;36m   \e[0m\n"' >> ~/.bashrc
}

display_banner
sleep 1
# verify_key  <-- This line is removed (bypassed)
startinstall
install_dockzivpn
tput sgr0
